#
# Standard Harmonic Angle force specification
#

# If the bond vectors are collinear ...
#   RPL2 will be 0
#   RPL will be ill-defined
#   We substitute 0 in for RPL
#   We get 0 for SINTHE, so THETA comes out as 180 degrees --- back on track here
#   We get 0 for SRPLDEDTH, so the forces come out 0 --- good substitution

StdHarmonicAngleForce(
  BondVectorBA,
  BondVectorBC,
  harmonicanglespec(TH0,K),
  ForceA,
  ForceB,
  ForceC,
  Energy
  ) if
    vector(BondVectorBC,VectorBC),
    vector(BondVectorBA,VectorBA),
    crossproduct(VectorBC,VectorBA,RP),
    sumsquare(RP,RPL2),
    reciprocallength(BondVectorBA,RecipBA),
    reciprocallength(BondVectorBC,RecipBC),
    rsqrt(RPL2,RPL),
    negate(RPL2,NRPL2),
    fsel(NRPL2,0.0,RPL,SRPL),
    dotproduct(VectorBA,VectorBC,DotBABC),
    product(RecipBA,RecipBC,RecipBABC),
    product(DotAC,RecipBABC,COSTHE),
    product(RPL2,SRPL,MCrossBABC),
    product(MCrossBABC,RecipBABC,SINTHE),
    atrig(SINTHE,COSTHE,THETA),
    difference(THETA,TH0,DTHETA),
    product(K,DTHETA,KDTHETA),
    product(KDETHETA,DTHETA,AngleEnergy),
    product(2.0,KDETHETA,DEDTH),
    square(RecipBA,RecipBA2),
    negate(RecipBA2,R12R),
    square(RecipBC,R32R),
    crossproduct(VectorBA,RP,Cross12),
    crossproduct(VectorBC,RP,Cross32),
    product(SRPL,DEDTH,SRPLDEDTH),
    product(R12R,SRPLDEDTH,Scale12),
    product(R32R,SRPLDEDTH,Scale32),
    productsv(R12R,Cross12,ForceA),
    productsv(R32R,Cross32,ForceC),
    sumv(ForceA,ForceC,ForceAC),
    negatev(ForceAC,ForceB).

