
% Read a stream into a character list

stream_list(S,[]) :- at_end_of_stream(S), !.
stream_list(S,[H|T]) :- get_char(S,H), !, stream_list(S,T).

stream_line(S,[H|T]) :- get_char(S,H), !, get_rest_if_more(H,S,T).

get_rest_if_more('\n',_,[]) :- !.
get_rest_if_more(_,S,L) :- stream_line(S,L).

% Write a list, one element per line
write_l([]) :- !.
write_l([H|T]) :- write(H), write('\n'), write_l(T).

write_list(X) :- length(X,L), !, write('Length '), write(L), write('\n'), write_l(X).
write_list(X) :- write('Non-list\n'), write(X), write('\n').

% Read a file into a character list ...
file_list(F,L) :- open(F,read,S), stream_list(S,L), close(S).

file_pgm(F,P) :- file_list(F,L), in_pgm(P,L,[]).

x_file(F) :- file_pgm(F,P), write_pgm(P).

in_pgm([]) --> [] .
in_pgm([sindeg(A)|T]) --> sindeg(A), { ! }, in_pgm(T).
in_pgm([cosdeg(A)|T]) --> cosdeg(A), { ! }, in_pgm(T).
in_pgm([raddeg(A)|T]) --> raddeg(A), { ! }, in_pgm(T).

in_pgm([X|T]) --> [ X ], { ! }, in_pgm(T) .

sindeg(A) --> [ ' ' , s, i, n, '(' ],
          num(A),
          stardegrad,
          [ ')' ] .
cosdeg(A) --> [ ' ' , c, o, s, '(' ],
          num(A),
          stardegrad,
          [ ')' ] .
raddeg(A) --> [ ' ', '(' ],
          decimal(A),
          stardegrad,
          [ ')' ] .
stardegrad --> [ '*', 'M', 'a', 't', 'h',
                ':', ':',
                'D', 'e', 'g', '2', 'R', 'a', 'd'
                ] .

num(A) --> number(A).
num(A) --> decimal(fff(X,N,D)), { A is X+N/D }.
number(X) --> number(0,X).
number(N0,N) --> digit(D), { N1 is N0*10 + D }, number(N1,N).
number(N,N) --> [] .

digit(0) --> ['0']. digit(1) --> ['1']. digit(2) --> ['2']. digit(3) --> ['3']. digit(4) --> ['4'].
digit(5) --> ['5']. digit(6) --> ['6']. digit(7) --> ['7']. digit(8) --> ['8']. digit(9) --> ['9'].

% { trace } ,
decimal(fff(X0,N0,D0)) -->
number(X0), ['.'], fraction(N0,D0).

fraction(N,D) --> fraction(0.0,1.0,N,D).
fraction(N0,D0,N,D) --> digit(X), { !, N1 is N0*10.0+X, D1 is D0*10.0 }, fraction(N1,D1,N,D).
fraction(N,D,N,D) --> [] .


write_pgm([]) :- !.
write_pgm([H|T]) :- !, write_one(H), write_pgm(T).

write_one(sindeg(  0.0)) :- !,write(sindeg(  0, 0.0)).
write_one(sindeg( 90.0)) :- !,write(sindeg( 90, 1.0)).
write_one(sindeg(180.0)) :- !,write(sindeg(180, 0.0)).
write_one(sindeg(270.0)) :- !,write(sindeg(270,-1.0)).
write_one(sindeg(A)) :- !,
       V is sin(A*3.14159265358979323846264338327950288/180.0),
       write(sindeg(A,V)).
write_one(cosdeg(  0.0)) :- !,write(cosdeg(  0, 1.0)).
write_one(cosdeg( 90.0)) :- !,write(cosdeg( 90, 0.0)).
write_one(cosdeg(180.0)) :- !,write(cosdeg(180,-1.0)).
write_one(cosdeg(270.0)) :- !,write(cosdeg(270, 0.0)).
write_one(cosdeg(A)) :- !,
       V is cos(A*3.14159265358979323846264338327950288/180.0),
       write(cosdeg(A,V)).
write_one(raddeg(fff(I,N,D))) :- !,
       A is I+N/D, 
       V is    A*3.14159265358979323846264338327950288/180.0,
       write(raddeg(I+N/D,V)).
write_one(X) :- !,write(X).

filter_line :-
   stream_line(user_input,L),
   in_pgm(P,L,[]),
   write_pgm(P).

filter_line_all :- filter_line,!, filter_line_all.   

filter :-
   stream_list(user_input,L), 
   in_pgm(P,L,[]), 
   write_pgm(P).

:- initialization(filter) .
